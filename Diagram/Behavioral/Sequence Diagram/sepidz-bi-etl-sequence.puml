@startuml
skinparam shadowing false
skinparam sequence {
    ArrowColor #2C3E50
    ActorBorderColor #2C3E50
    LifeLineBorderColor #3498DB
    LifeLineBackgroundColor #ECF0F1
    ParticipantBorderColor #2980B9
    ParticipantBackgroundColor #3498DB
    ParticipantFontColor white
}

title SepidZ BI – Sequence Diagram: فرآیند کامل ETL (Increment 1)

actor "مدیر سیستم / Scheduler" as Admin
participant "ETL Orchestrator\n(FastAPI + APScheduler)" as Orchestrator
participant "POS Source System\n(SepidZ Core DB)" as POS
participant "ETL Service" as ETL
participant "Data Quality Engine\n(Python + Great Expectations)" as DQ
participant "Kimball Data Warehouse\n(PostgreSQL)" as DW
participant "Audit & Log Service" as Log

autonumber

Admin -> Orchestrator : شروع فرآیند ETL (دستی یا زمان‌بندی شده)
activate Orchestrator

Orchestrator -> ETL : trigger_daily_etl()
activate ETL

ETL -> POS : extract_sales_transactions()\nextract_inventory()\nextract_customers()
activate POS
POS --> ETL : raw_data (JSON/DF)
deactivate POS

ETL -> DQ : validate_raw_data(raw_data)
activate DQ
alt داده معتبر
    DQ --> ETL : validation_passed = true
else خطا در کیفیت داده
    DQ --> ETL : validation_failed
    ETL -> Log : log_data_quality_issue(details)
    activate Log
    Log --> ETL : logged
    deactivate Log
    ETL --> Orchestrator : partial_failure
    deactivate DQ
    deactivate ETL
    note right: هشدار به مدیر + ادامه با داده‌های معتبر
end

ETL -> ETL : transform_to_kimball_model()
note right
  تبدیل به مدل ستاره‌ای:
  - FactSales
  - FactInventoryMovement
  - DimProduct, DimCustomer
  - DimDate, DimBranch, DimTime
end note

ETL -> DW : load_fact_sales(fact_data)
activate DW
DW --> ETL : loaded rows: 12,450
deactivate DW

ETL -> DW : load_dim_product(dim_data)
activate DW
DW --> ETL : upserted rows: 89
deactivate DW

ETL -> DW : load_dim_customer(dim_data)
activate DW
DW --> ETL : upserted rows: 1,234
deactivate DW

'... بارگذاری سایر ابعاد

ETL -> Log : log_etl_success(summary)
activate Log
Log --> ETL : logged
deactivate Log

ETL --> Orchestrator : etl_completed_successfully()
deactivate ETL

Orchestrator -> Admin : ارسال نوتیفیکیشن\n(ایمیل / داشبورد مانیتورینگ)
deactivate Orchestrator

note over DW
  انبار داده حالا آماده برای
  گزارش‌گیری و مدل‌های پیش‌بینی است
end note

@enduml